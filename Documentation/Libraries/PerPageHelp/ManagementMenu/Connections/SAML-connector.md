| ソース | 翻訳元 URL | 翻訳日 |
| ---- | ---- | ---- |
| OpenAthens Docs | [SAML connector](https://docs.openathens.net/libraries/SAML-connector.11567862.html) | 2022-05-25 |
# SAML コネクター

OpenAthens は、Azure、G Suite、OneLog、OpenAthens LA、Shibboleth などの SAML ソースと接続できるため、ユーザーに個人アカウントを発行する必要がありません (OpenAthens 管理者アカウントは引き続き必要です)。

別の認証情報セットを維持する代わりにローカルアカウントを使用できるだけでなく、すでにディスカバリー（ユーザーのホーム組織の特定）を伴っているフェデレーション・リソースへのアクセスは、ユーザーを直接SAMLログインに導くことができます。

### 準備

作業を開始する前に、以下が必要です:

* ドメインレベルでの OpenAthens 管理領域へのアクセス。
* SAML ソースとそのメタデータ (ファイルまたは公開されている Web アドレス)。
* その SAML ソースの構成へのアクセス。
* TLS 1.2 以上をサポートし、SAML 標準に準拠する SAML ソース。


Shibboleth などの代替 IdP から移行する場合は、以下も参照してください： [Migrating from your own IdP](https://docs.openathens.net/libraries/Migrating-from-your-own-IdP.11567392.html)

もし何かわからないことがあったり、行き詰まったりした場合は、私たちが喜んでお手伝いします。管理画面の右上にあるサポートリンクをクリックすると、お近くのサポート担当者につながります。

### OpenAthensで接続を追加する

ドメイン管理者として管理インターフェイスで、 Management > Connections を選択します。

1.  左のaddボタンをクリックし、オプションからSAMLを選択します。   

2.  SAML メタデータの URL を入力するか、SAML ソースを表す xml ファイルをアップロードします。  


    1.  メタデータのURLは通常、`https://YOURDOMAIN/path/metadata` のようなもので、ネットワーク外からアクセスできる必要があります。 


3.  ユーザー識別子フィールドを、ユーザー識別子として送信する属性と一致するように設定します。これは後で変更することができますが、ページを保存するために値を持つ必要があります。

4.  使用したい属性に合わせて表示名を設定します。1つの属性しか送信しない場合は、ユーザー識別子と同じものを設定することができます。これも後で変更可能ですが、ページを保存するために値を設定する必要があります。

5.  この時点では、デフォルトとして設定しないでください。

6.  変更を保存します。 

7.  「Relying party」タブに移動し、メタデータのアドレスをメモします。 これを使用して、SAML ソースを構成します。

このような画面が表示されます：

![SAML Example](https://docs.openathens.net/libraries/11567862/SAML.Example.png?inst-v=f79effe0-b2fa-4160-b4b6-3b5d44ab3470)

表示される詳細フィールドは次のとおりです：

|  フィールド  |  説明  |
| ---- | ---- |
|  Display name  |  コネクタの選択がある際に、認証ポイントで表示される接続の名前。デフォルトは、SAML メタデータで指定された名前です。  |
|  Metadata URL  |  SAML メタデータが公開される場所。URL からメタデータが読み込まれたときにのみ入力され、SAML システムが変更されたときに接続を簡単に更新できるようにします。  |
|  EntityID  |  	SAML インスタンスのエンティティ識別子。OpenAthens LA の場合は通常、`http://YOURDOMAIN/oala/metata` 。SAML メタデータから取得。  |
|  SSO endpoint  |  ログインアドレス。通常、`https://YOURDOMAIN/oala/sso` 。SAML メタデータから取得。 |
|  DIsplay name attribute  |  ここで指定した属性は、アカウントリストやauditで表示される値を供給します。人間が読めるようなものを推奨します。これは、Unique user属性と異なるものである必要はありません。  |
|  Unique user attribute  |  ここで指定する属性は、現在のユーザー・セット内でそのユーザーに固有の永続的な値を提供する必要があり、そのユーザーに固有の仮名値を常に提供する必要があります。これはシステムでユーザーを区別するために使用され、またTargetedIDや統計の生成にも使用されます。ログイン時に入力されたユーザー名である必要はありません。<br>ここで SAML NameID を使用する場合、ユニークかつ永続的という要件から、タイプは以下のように制限されます。<ul><li>urn:oasis:names:tc:SAML:2.0:nameid-format:persistent</li><li>urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress</li></ul> |
|  Status  | Not live = 接続はデバッグモードでのみ使用可能です。visibilityとdefaultフラグは無視されます。<br>Live and visible (これが唯一のローカル接続である場合) = 接続はデバッグモードでのみ使用可能です。 <br>Live and visible (複数のライブ接続と可視化された接続がある場合) = ユーザーは、この接続を含む選択肢を提供されます。OpenAthensのアカウントを含めるかどうかは、ドメインの設定によります。<br>Live & visible & default = これは、あなたの唯一のログインオプションであり、組織が知られているときはいつでも、ユーザーはあなたのログインに直接送信されます。認証に成功すると、認証ポイントはその場所を記憶します。認証に失敗すると、その設定はクリアされます。デバッグモードでは、他のログインオプションは表示されません。<br>ステータスの変更は、通常、瞬時に反映されます。  |
|  Create local accounts  |  Automatically - あなたのシステムで認証され、私たちに引き渡されたユーザーは、問題ないとみなされ、システムで受け入れられます。<br>Manually - リストページで過去にアップロードしたユーザーIDのみ、私たちのシステムで受け付けます。  |
|  Remove local accounts  |  この設定は、ローカルアカウントのデータがシステムから自動的にクリアされるタイミングを制御し、アカウントが最後にサインインした日からの日数を指定します。また、マップ済みのアカウントで未確認のものもクリアされます。<br>設定可能な日数は1～365日で、そのアカウントが最後にサインインした日から経過した完全な日数を表します。つまり、最後にサインインした日はカウントに含まれません。こちらもご覧ください：[How to modify a local account](https://docs.openathens.net/libraries/How-to-modify-a-local-account.11010371.html)  |
|  Salt value  |  この接続で認証されたユーザーのTargetedIDを生成するために使用されるソルト。<br>Shibbolethのようなものから移行する場合、ユーザがシステムを変更しても同じTargetedIDの値を持つことができるように、これを編集することができます。空白にすると、接続はMDアカウントと同じソルトを使用します<br>本稼働後にこの設定を変更すると、サービスプロバイダーから見たユーザーの識別子が変わってしまうので、望ましいことではありません。  |

### SAMLソースにOpenAthensメタデータを追加し、属性リリースを設定する。

「サービス・プロバイダに接続する」ように構成する方法については、SAML ソースのドキュメントを参照する必要があります。Azure や Google など、より一般的な SAML ソースについては、「[サードパーティ製アプリ](https://docs.openathens.net/tpa/Sign-into-OpenAthens-with-local-authentication-systems.12451899.html)」のセクションにヘルプが用意されています。

このために使用するOpenAthensのメタデータは、OpenAthensで設定した接続のRelying partyタブで引用されているアドレスにあり、以下のような内容になっています： https:\//login.openathens.net/saml/2/metadata-sp/domain.com/la/123456


<details>
<summary>メタデータを受け付けないIdPで、設定を手動で入力する必要がある場合</summary>

|  設定  |  値  |
| ---- | ---- |
| EntityID / Provider ID / ID | The same as the OpenAthens metadata address,<br>e.g: https:\//login.openathens.net/saml/2/metadata-sp/domain.com/la/123456 |
| ACS / Association Consumer Service / Binding address / Reply address | Almost the same as the OpenAthens metadata address (change 'metadata-sp' to 'acs'),<br>e.g: https:\//login.openathens.net/saml/2/acs/domain.com/la/123456 |
| Binding method | POST |
| Certificate | see https://docs.openathens.net/libraries/SAML-connector.11567862.html |
</details>

最低限、一意のユーザ識別子（unique user identifier）を公開する必要があります。この識別子は属性として送ることもできますし、SAML NameID として送ることもできますが、永続的で現在のユーザ間で一意である必要があります。理想的には、仮名でずっと一意であることです (つまり、新しいユーザに割り当てられることが絶対にありません)。  

図書館のニーズによっては、一意のユーザー識別子（unique user identifier）で十分な場合もありますが、通常はより多くの情報を公開して、ローカルの属性を OpenAthens の属性にマップし、組織、統計、リソースアクセス、表示名、リソース割り当てに使用できるようにします。例えば：

* 図書館がユーザーを識別するための姓名または表示名（ユニークユーザー属性はこれに適していないはずです）。
* 図書館がユーザーに連絡し、場合によってはそのデータをサービス・プロバイダーに公開するためのEメールアドレス。
* ルールに基づいてユーザーの異なるグループに異なるパーミッション・セットを割り当てるための、グループのメンバーシップを示す属性。
* 統計を取るための部署名またはOU名。
すべての場合において、図書館は次のセットアップのために属性名を必要とします。属性名は大文字と小文字を区別し、スペースを含んではいけません。

## マッピングとパーミッション・セットの設定 
最後に設定するのは、パーミッション・セットのルールとアトリビュート・マッピングの2つのエリアです：

* ユーザーに適切なリソース・セットを割り当てるためのパーミッション・セットのルール
* OpenAthens がソースから渡されたデータを利用できるよう、アトリビュート・マッピングを行います。
    * OpenAthens は、ユーザーがサインインしたときにこれらの属性をキャッシュするので、ユーザーが次に OpenAthens セッションを開始するまで、ディレクトリ内の変更は反映されません。

本稼働の準備ができたら、live と visible の両方のボックスをチェックし、保存します。数秒後には、新しい接続がテストできるようになっているはずです。

## テスト方法
ディスカバリーは、接続をlive かつ visibleに設定するまで使用できません。これは、使用する準備ができていないオプションをユーザーに提示しないようにするためです。接続をテストするには、デバッグモードを使用して、接続を選択できるようにする必要があります。

テストして問題がなければ、接続をlive、visible、必要に応じてデフォルトとして設定し、保存します。これで、数秒後にはユーザーが実際に接続できるようになります。

## 複数のコネクターとOpenAthensのアカウント
このタイプのコネクタは、デフォルトの接続として使用するのが最適です。このモードでは、ユーザーがリソースのログイン時に選択したり、WAYFless URL やRedirectorを使用したり、以前に認証に成功した場合など、あなたの組織がわかっている状態で認証ポイントに到着すると、私たちの認証ポイントを見ることなくあなたのログインに直接渡されます。

複数の接続やOpenAthensアカウントをローカルアカウントと一緒に使用する必要がある場合（ディレクトリにないユーザーグループがある場合など）、接続をliveかつvisibleにしますが、デフォルトにはしません。そして、domain preferences ページの設定によりOpenAthensアカウントを許可するよう設定します。このモードでは、ユーザーが、あなたの組織を知っている状態の認証ポイントに到着すると、使用する接続を選択するためのチューザーが最初に表示されます - すべてのliveかつvisibleになっているローカル接続と、OpenAthensアカウントを使用するオプションが用意されています。認証ポイントは、ユーザーが選択した接続を記憶します。

![choose](https://docs.openathens.net/libraries/13467661/Davecision.Box.png?inst-v=f79effe0-b2fa-4160-b4b6-3b5d44ab3470)


## 多値属性
複数の値を持つ属性（例えばADFSのmemberOfフィールド）では、インターフェースはすべての値を表示することができず、1つの値のみを表示します。しかし、すべての値は読み込まれ、キャッシュされるので、パーミッション・セットのルールや属性リリースのようなことに利用できます。

#### その他のタブ 
Certificates - 2つ目の証明書を追加することができます。サーバー証明書を変更する必要があり、ユーザーへのダウンタイムを最小限に抑えたい場合に使用します。

Advanced - いくつかの変更を可能にしますが、必要となる場合はあまりありません：

* 古い SAML 1 プロファイルしか扱えないソースがある場合、SAML バージョン間の切り替えが可能です。
* ソースから要求があれば、プロファイルを Redirect から Post に変更できます。
* 認証要求の署名(SHA-1またはSHA-256)が必要な場合、それを有効にします。
* SAML forceAuthn オプションを有効にする (ユーザがローカル・ソースに送信されるたびに再認証を強制します。たとえば、ユーザがコンソーシアム内で複数の所属を持ち、SAML ソースのセッション管理によって変更が困難な場合など)。
#### 何か気をつけることはありますか？
refresh metadataボタンを使用すると、接続のエンドポイントや証明書がメタデータの値で更新されます。名前と他のタブのオプションは変更されません。

ユーザー ID の事前アップロードを計画している場合、アップロードボタンにアクセスするために、少なくとも 1 つのローカルアカウントがリストに表示されている必要があります。少なくともいくつかの事前マッピングがアップロードされるまで、テスト用ログインをすべて削除することはしないでください。

#### 仮名（Pseudonymous）とは? 

一意のユーザー属性（unique user attribute）は、他のマッピングされた属性がクリアされた後も、その識別子がaudit trailにしばらく残ります。そのため、データ保護法に関する潜在的な問題を避けるために、一意のユーザー属性には仮名の識別子を使用することが推奨されます。