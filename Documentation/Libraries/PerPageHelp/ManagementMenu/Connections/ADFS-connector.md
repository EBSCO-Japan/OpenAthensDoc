| ソース | 翻訳元 URL | 翻訳日 |
| ---- | ---- | ---- |
| OpenAthens Docs | [ADFS connector](https://docs.openathens.net/libraries/ADFS-connector.11436549.html) | 2022-05-25 |

# ADFS コネクター

パス: Management > Connections > Add > ADFS

OpenAthens は、ADFS (Active Directory Federation Services) と接続できるため、ユーザーに個人アカウントを発行する必要がありません (OpenAthens 管理者アカウントは引き続き必要です)。

別の認証情報セットを維持する代わりにローカルアカウントを使用できるだけでなく、すでにディスカバリー（ユーザーのホーム組織の特定）を伴っているフェデレーション・リソースへのアクセスは、ユーザーを直接ADFSログインに導くことができます。

## 準備 
作業を開始する前に、以下が必要です:

* ADFS v2.0 以上（推奨）が動作する Windows Server 2008R2 以降。
* ADFS を設定し、メタデータを提供する IT チームのメンバー。
    * ADFS メタデータの、外部からアクセス URL が理想的ですが、無ければXML ファイル形式のメタデータのコピー。
* すべてのユーザがディレクトリに存在すること。
* ドメインレベルでの OpenAthens 管理エリアへのアクセス権。
Shibboleth などの代替 IdP から移行する場合は、[Migrating from your own IdP](https://docs.openathens.net/libraries/Migrating-from-your-own-IdP.11567392.html)も参照してください。

もし何かわからないことがあったり、行き詰まったりした場合は、私たちが喜んでお手伝いします。管理画面の右上にあるサポートリンクをクリックすると、お近くのサポート担当者につながります。

## OpenAthensで接続を追加する
ドメイン管理者として管理インターフェイスで、 Management > Connections を選択します。

(ADFSがすでにSAML接続として表示されている場合は、その接続を削除してから、再び追加する必要があります）

1. 左のaddボタンをクリックし、ADFSを選択します。




1. IT チームから提供されたADFS メタデータの URL を入力するか、xml ファイルをアップロードしてください。

    1. メタデータのURLは通常、 https://YOURDOMAIN/FederationMetadata/2007-06/FederationMetadata.xml のようなもので、ネットワーク外からアクセスできる必要があります。

1. ユーザー識別子フィールドを、ユーザー識別子として送信するクレームと一致するように設定します。これは後で変更することができますが、ページを保存するために値を持つ必要があります。

1. 使用するクレームに合わせた表示名を設定します。1つのクレームしか送信しない場合は、ユーザー識別子と同じに設定することができます。これも後で変更可能ですが、ページを保存するために値を持つ必要があります。

1. この時点では、デフォルトとして設定しないでください。

1. 変更を保存します。 

1. 「Relying party」タブに移動し、そこに表示されているメタデータのアドレスをメモしておきます。OpenAthensをADFSに追加する際に必要になります。
表示される詳細フィールドは次のとおりです：

|  フィールド  |  説明  |
| ---- | ---- |
|  Display name  |  コネクタの選択がある際に、認証ポイントで表示される接続の名前。デフォルトは、ADFS メタデータで指定された名前です。  |
|  Metadata URL  |  ADFS メタデータが公開される場所。URL からメタデータが読み込まれたときにのみ入力され、ADFS システムが変更されたときに接続を簡単に更新できるようにします。  |
|  EntityID  |  	ADFS インスタンスのエンティティ識別子。通常、http://YOURDOMAIN/adfs/services/trust 。ADFS メタデータから取得。  |
|  SSO endpoint  |  ログインアドレス。通常、https://YOURDOMAIN/adfs/ls/ 。ADFS メタデータから取得。 |
|  Display name attribute  |  ここで指定した属性は、アカウントリストやauditで通常OpenAthensのユーザー名が表示される場所に表示される値を供給します。人間が読めるようなものを推奨します。DisplayName が一般的なソースですが、Unique user attribute claim と異なるものである必要はありません。  |
|  Unique user attribute  |  ここで指定するクレームは、現在のユーザーセット内でそのユーザーに固有の値でなくてはなりません。かつ、そのユーザーに固有の仮名値を常に提供しなくてはなりません。これはシステムでユーザーを区別するために使用され、またTargetedIDや統計の生成にも使用されます。これは、ログイン時に入力されたユーザー名である必要はありません。よく使われるのはObjectGUIDです。 |
|  Status  | Not live = 接続はデバッグモードでのみ使用可能です。visibilityとdefaultフラグは無視されます。<br>Live and visible (これが唯一のローカル接続である場合) = 接続はデバッグモードでのみ使用可能です。 <br>Live and visible (複数のライブ接続と可視化された接続がある場合) = ユーザーは、この接続を含む選択肢を提供されます。OpenAthensのアカウントを含めるかどうかは、ドメインの設定によります。<br>Live & visible & default = これは、あなたの唯一のログインオプションであり、組織が知られているときはいつでも、ユーザーはあなたのログインに直接送信されます。認証に成功すると、認証ポイントはその場所を記憶します。認証に失敗すると、その設定はクリアされます。デバッグモードでは、他のログインオプションは表示されません。<br>ステータスの変更は、通常、瞬時に反映されます。  |
|  Create local accounts  |  Automatically - あなたのシステムで認証され、私たちに引き渡されたユーザーは、問題ないとみなされ、システムで受け入れられます。<br>Manually - リストページで過去にアップロードしたユーザーIDのみ、私たちのシステムで受け付けます。  |
|  Remove local accounts  |  この設定は、ローカルアカウントのデータがシステムから自動的にクリアされるタイミングを制御し、アカウントが最後にサインインした日からの日数を指定します。また、マップ済みのアカウントで未確認のものもクリアされます。<br>設定可能な日数は1～365日で、そのアカウントが最後にサインインした日から経過した完全な日数を表します。つまり、最後にサインインした日はカウントに含まれません。こちらもご覧ください：[How to modify a local account](https://docs.openathens.net/libraries/How-to-modify-a-local-account.11010371.html)  |
|  Salt value  |  この接続で認証されたユーザーのTargetedIDを生成するために使用されるソルト。<br>OpenAthens LA などから MD に移行する際にこの値を編集し、 ユーザがシステムを変更しても同じ TargetedID 値を保持できるようにします。これを空白にすると、MD アカウントと同じ salt を使用するようになります。<br>本稼働後にこの設定を変更すると、サービスプロバイダーから見たユーザーの識別子が変わってしまうので、望ましいことではありません。  |

## ADFSのrelying partyとしてOpenAthensを追加する。

次のセクションは、あなたがADFSに精通していることを前提としています。そうでない場合は、次の3つのステップでより詳細なガイドを利用できます。

1. ADFS管理コンソールで、先ほど記録したOpenAthensのメタデータのアドレスを使用して、新しいrelying partyを追加します。

1. 最低限一つのユーザ識別子属性を解放するようクレームルールを編集する。

    1. シンプルな「Send LDAP Attributes as Claims」ルールで充分です。

    1. クレーム値は現在のユーザ間で一意でなければならず、理想的には仮名で永久に一意であるべきです。objectGUIDのようなものが良い選択でしょう。

    1. 命名に関する考慮点
        1. ADFSの名前空間に慣れていない場合、あるいは図書館の同僚が目にするインターフェースに、より意味のある名前を付けたい場合、予約語を誤って使用しないように、クレーム名の前に「oa_」のようなものを付けてください(例: 「oa_username」)。
        1. クレーム名にスペースを含んではいけません。

1. 保存

図書館のニーズによってはこれで十分かもしれませんが、通常はより多くの情報を公開して、クレームを OpenAthens の属性にマップし、組織、統計、リソースアクセス、表示名、リソース割り当てに利用できるようにします。例えば：

* 図書館が利用者を特定するために必要な姓と名。
* 図書館がユーザーに連絡したり、場合によってはそのデータをサービスプロバイダーに公開するための電子メールアドレス。
* ルールに基づいてユーザーの異なるグループに異なる権限セットを割り当てることができるようにするための memberOf などの属性。
* 表示名として使用される属性。
* 統計の集計のための部署名または OU 名。

どのような場合でも、図書館は次のセットアップのためにクレームの名前を必要とします。クレーム名は大文字と小文字が区別されます。

Issuance transform ruleの例:

![ADFSClaims](https://docs.openathens.net/libraries/11436549/ADFS.Claims.png?inst-v=f79effe0-b2fa-4160-b4b6-3b5d44ab3470)

ADは、sAMAccountNameが20文字以上の場合、リリース前に切り捨てます。これは、一意のユーザー属性（unique user attribute）の選択に影響を与える可能性があります。

## マッピングとパーミッション・セットの設定 
最後に設定するのは、パーミッション・セットのルールとアトリビュート・マッピングの2つのエリアです：

* ユーザーに適切なリソース・セットを割り当てるためのパーミッション・セットのルール
* OpenAthens がディレクトリから利用可能なデータを使用できるようにするための属性マッピング
    * OpenAthens は、ユーザーがサインインするときにこれらの属性をキャッシュするため、ユーザーが次に OpenAthens セッションを開始するまで、ActiveDirectory の変更は反映されません。
本稼働の準備ができたら、live と visible の両方のボックスをチェックし、保存します。数秒後には、新しい接続がテストできるようになっているはずです。

## テスト方法
ディスカバリーは、接続をlive かつ visibleに設定するまで使用できません。これは、使用する準備ができていないオプションをユーザーに提示しないようにするためです。接続をテストするには、デバッグモードを使用して、接続を選択できるようにする必要があります。

テストして問題がなければ、接続をlive、visible、必要に応じてデフォルトとして設定し、保存します。これで、数秒後にはユーザーが実際に接続できるようになります。

## 複数のコネクターとOpenAthensのアカウント
このタイプのコネクタは、デフォルトの接続として使用するのが最適です。このモードでは、ユーザーがリソースのログイン時に選択したり、WAYFless URL やRedirectorを使用したり、以前に認証に成功した場合など、あなたの組織がわかっている状態で認証ポイントに到着すると、私たちの認証ポイントを見ることなくあなたのログインに直接渡されます。

複数の接続やOpenAthensアカウントをローカルアカウントと一緒に使用する必要がある場合（ディレクトリにないユーザーグループがある場合など）、接続をliveかつvisibleにしますが、デフォルトにはしません。そして、domain preferences ページの設定によりOpenAthensアカウントを許可するよう設定します。このモードでは、ユーザーが、あなたの組織を知っている状態の認証ポイントに到着すると、使用する接続を選択するためのチューザーが最初に表示されます - すべてのliveかつvisibleになっているローカル接続と、OpenAthensアカウントを使用するオプションが用意されています。認証ポイントは、ユーザーが選択した接続を記憶します。

![choose](https://docs.openathens.net/libraries/13467661/Davecision.Box.png?inst-v=f79effe0-b2fa-4160-b4b6-3b5d44ab3470)


## 多値属性
複数の値を持つ属性（例えばADFSのmemberOfフィールド）では、インターフェースはすべての値を表示することができず、1つの値のみを表示します。しかし、すべての値は読み込まれ、キャッシュされるので、パーミッション・セットのルールや属性リリースのようなことに利用できます。

#### その他のタブ 
Certificates - 2つ目の証明書を追加することができます。ADのサーバー証明書を変更する必要があり、ユーザーへのダウンタイムを最小限に抑えたい場合に使用します。

Advanced - いくつかの変更を可能にしますが、必要となる場合はあまりありません：

* 古い SAML 1 プロファイルしか扱えないソースがある場合、SAML バージョン間の切り替えが可能です。
* ソースから要求があれば、プロファイルを Redirect から Post に変更できます。
* 認証要求の署名(SHA-1またはSHA-256)が必要な場合、それを有効にします。
* SAML forceAuthn オプションを有効にする (ユーザがローカル・ソースに送信されるたびに再認証を強制します。たとえば、ユーザがコンソーシアム内で複数の所属を持ち、SAML ソースのセッション管理によって変更が困難な場合など)。
#### 何か気をつけることはありますか？
refresh metadataボタンを使用すると、接続のエンドポイントや証明書がメタデータの値で更新されます。名前と他のタブのオプションは変更されません。

何らかの理由でADFSシステムが1.2より前のTLSバージョンを使用するようにロックされている場合、接続を拒否することになり、動作しないことになります。

#### 仮名（Pseudonymous）とは? 

一意のユーザー属性（unique user attribute）は、他のマッピングされた属性がクリアされた後も、その識別子がaudit trailにしばらく残ります。そのため、データ保護法に関する潜在的な問題を避けるために、一意のユーザー属性には仮名の識別子を使用することが推奨されます。